PassengerDefaultUser chef

# This virtual host is for chef-client use. It only authenticates by IP address (chef-server uses openid)
<VirtualHost *:443>
  ServerAdmin     <%= @node[:base][:sysadmin_email] %>
  ServerName      chef.<%= @node[:domain] %>
  DocumentRoot    <%= @node[:chef][:server_path]%>/lib/public
  ErrorLog        /var/log/chef/apache_error.log
	SSLEngine       On

	# Enforce a decent level of encryption
	SSLProtocol -ALL +SSLv3 +TLSv1
	SSLCipherSuite ALL:!aNULL:!ADH:!eNULL:!LOW:!EXP:RC4+RSA:+HIGH:+MEDIUM

	SSLCertificateFile       /var/chef/certificates/chef.<%= @node[:domain] %>.crt
	SSLCertificateKeyFile    /var/chef/certificates/chef.<%= @node[:domain] %>.key

</VirtualHost>

# This virtual host is for chef adminstrator use. It authenticates with username/password and a yubikey

<VirtualHost *:444>
  ServerAdmin     <%= @node[:base][:sysadmin_email] %>
  ServerName      chefadmin.<%= @node[:domain] %>
  DocumentRoot    <%= @node[:chef][:server_path]%>/lib/public
  ErrorLog        /var/log/chef/apache_error.log
	SSLEngine       On

	# Enforce a decent level of encryption
	SSLProtocol -ALL +SSLv3 +TLSv1
	SSLCipherSuite ALL:!aNULL:!ADH:!eNULL:!LOW:!EXP:RC4+RSA:+HIGH:+MEDIUM

	SSLCertificateFile       /var/chef/certificates/chef.<%= @node[:domain] %>.crt
	SSLCertificateKeyFile    /var/chef/certificates/chef.<%= @node[:domain] %>.key

	<Location />
		AuthType Basic
		AuthBasicProvider yubikey
		AuthName "Login"
		AuthYubiKeyTimeout 30
		AuthYubiKeyTmpFile conf.d/yubikey_tmp
		AuthYubiKeyUserFile conf.d/yubikey_user
		AuthYubiKeyRequireSecure On
		AuthYubiKeyExternalErrorPage Off
		Require valid-user
	</Location>

</VirtualHost>